\section{Bucardo}
\subsection{Введение}
Bucardo~--- асинхронная master-master или master-slave репликация PostgreSQL, которая написана на Perl. Система очень гибкая, поддерживает несколько видов синхронизации и обработки конфликтов.

\subsection{Установка}

Установку будет проводиться на Ubuntu Server. Сначала нам нужно установить DBIx::Safe Perl модуль.

\begin{lstlisting}[language=Bash,label=lst:bucardo1,caption=Установка]
$ apt-get install libdbix-safe-perl
\end{lstlisting}

Для других систем можно поставить из \href{http://search.cpan.org/CPAN/authors/id/T/TU/TURNSTEP/}{исходников}:

\begin{lstlisting}[language=Bash,label=lst:bucardo2,caption=Установка]
$ tar xvfz dbix_safe.tar.gz
$ cd DBIx-Safe-1.2.5
$ perl Makefile.PL
$ make
$ make test
$ sudo make install
\end{lstlisting}

Теперь ставим сам Bucardo. \href{http://bucardo.org/wiki/Bucardo#Obtaining_Bucardo}{Скачиваем} его и инсталлируем:

\begin{lstlisting}[language=Bash,label=lst:bucardo3,caption=Установка]
$ wget http://bucardo.org/downloads/Bucardo-5.0.0.tar.gz
$ tar xvfz Bucardo-5.0.0.tar.gz
$ cd Bucardo-5.0.0
$ perl Makefile.PL
$ make
$ sudo make install
\end{lstlisting}

Для работы Bucardo потребуется установить поддержку pl/perl языка PostgreSQL.

\begin{lstlisting}[language=Bash,label=lst:bucardo4,caption=Установка]
$ sudo aptitude install postgresql-plperl-9.3
\end{lstlisting}

и дополнительные пакеты для Perl (DBI, DBD::Pg, Test::Simple, boolean):

\begin{lstlisting}[language=Bash,label=lst:bucardo-packet1,caption=Установка]
$ sudo aptitude install libdbd-pg-perl libboolean-perl
\end{lstlisting}

Можем приступать к настройке.

\subsection{Настройка}

\subsubsection{Инициализация Bucardo}

Запускаем установку командой:

\begin{lstlisting}[language=Bash,label=lst:bucardo5,caption=Инициализация Bucardo]
$ bucardo install
\end{lstlisting}

Bucardo покажет настройки подключения к PostgreSQL, которые можно будет изменить:

\begin{lstlisting}[language=Bash,label=lst:bucardo6,caption=Инициализация Bucardo]
This will install the bucardo database into an existing Postgres cluster.
Postgres must have been compiled with Perl support,
and you must connect as a superuser

We will create a new superuser named 'bucardo',
and make it the owner of a new database named 'bucardo'

Current connection settings:
1. Host:          <none>
2. Port:          5432
3. User:          postgres
4. Database:      postgres
5. PID directory: /var/run/bucardo
\end{lstlisting}

Когда вы измените требуемые настройки и подтвердите установку, Bucardo создаст пользователя bucardo и базу данных bucardo.
Данный пользователь должен иметь право логиниться через Unix socket, поэтому лучше заранее дать ему такие права в \lstinline!pg_hda.conf!.

После успешной установки мы можем проверить конфигурацию через команду \lstinline!bucardo show all!:

\begin{lstlisting}[language=Bash,label=lst:bucardo-status1,caption=Инициализация Bucardo]
$ bucardo show all
autosync_ddl              = newcol
bucardo_initial_version   = 5.0.0
bucardo_vac               = 1
bucardo_version           = 5.0.0
ctl_checkonkids_time      = 10
ctl_createkid_time        = 0.5
ctl_sleep                 = 0.2
default_conflict_strategy = bucardo_latest
default_email_from        = nobody@example.com
default_email_host        = localhost
default_email_to          = nobody@example.com
...
\end{lstlisting}

\subsubsection{Настройка баз данных}

Теперь нам нужно настроить базы данных, с которыми будет работать Bucardo. Пусть у нас будет \lstinline!master_db! и \lstinline!slave_db!. Реплицировать будем \lstinline!simple_database! базу. Сначала настроим мастер:

\begin{lstlisting}[language=Bash,label=lst:bucardo7,caption=Настройка баз данных]
$ bucardo add db master_db dbname=simple_database host=master_host
Added database "master_db"
\end{lstlisting}

Данной командой мы указали базу данных и дали ей имя \lstinline!master_db! (для того, что в реальной жизни \lstinline!master_db! и \lstinline!slave_db!
имеют одинаковое название базы \lstinline!simple_database! и их нужно отличать в Bucardo).

Дальше добавляем \lstinline!slave_db!:

\begin{lstlisting}[language=Bash,label=lst:bucardo8,caption=Настройка баз данных]
$ bucardo add db slave_db dbname=simple_database port=5432 host=slave_host
\end{lstlisting}

\subsubsection{Настройка репликации}

Теперь нам нужно настроить синхронизацию между этими базами данных. Делается это командой \lstinline!sync!:

\begin{lstlisting}[language=Bash,label=lst:bucardo9,caption=Настройка репликации]
$ bucardo add sync delta dbs=master_db:source,slave_db:target conflict_strategy=bucardo_latest tables=all
Added sync "delta"
Created a new relgroup named "delta"
Created a new dbgroup named "delta"
  Added table "public.pgbench_accounts"
  Added table "public.pgbench_branches"
  Added table "public.pgbench_history"
  Added table "public.pgbench_tellers"
\end{lstlisting}

Данной командой мы установим Bucardo триггеры в PostgreSQL для master-slave репликации. Значения параметров:

\begin{itemize}
  \item \lstinline!dbs!~--- список баз данных, которые следует синхронизировать. Значение \lstinline!source! или \lstinline!target! указывает, что это master или slave база данных соответственно (их может быть больше одной);

  \item \lstinline!conflict_strategy!~--- для работы в режиме master-master нужно указать как Bucardo должен решать конфликты синхронизации. Существуют следующие стратегии:

  \begin{itemize}
    \item \lstinline!bucardo_source!~--- при конфликте мы копируем данные с source;
    \item \lstinline!bucardo_target!~--- при конфликте мы копируем данные с target;
    \item \lstinline!bucardo_skip!~--- конфликт мы просто не реплицируем. Не рекомендуется для продакшен систем;
    \item \lstinline!bucardo_random!~--- каждая БД имеет одинаковый шанс, что её изменение будет взято для решение конфликта;
    \item \lstinline!bucardo_latest!~--- запись, которая была последней изменена решает конфликт;
    \item \lstinline!bucardo_abort!~--- синхронизация прерывается;
  \end{itemize}

  \item \lstinline!tables!~--- таблици, которые требуется синхронизировать. Через <<all>> указываем все;
\end{itemize}

Для master-master репликации:

\begin{lstlisting}[language=Bash,label=lst:bucardo10,caption=Настройка репликации]
$ bucardo add sync delta dbs=master_db:source,slave_db:source conflict_strategy=bucardo_latest tables=all
\end{lstlisting}

Пример для создания master-master и master-slave репликации:

\begin{lstlisting}[language=Bash,label=lst:bucardo-master-slave1,caption=Настройка репликации]
$ bucardo add sync delta dbs=master_db1:source,master_db2:source,slave_db1:target,slave_db2:target conflict_strategy=bucardo_latest tables=all
\end{lstlisting}

Проверка состояния репликации:

\begin{lstlisting}[language=Bash,label=lst:bucardo-master-slave2,caption=Проверка состояния репликации]
$ bucardo status
PID of Bucardo MCP: 12122
 Name    State    Last good    Time     Last I/D    Last bad    Time
=======+========+============+========+===========+===========+=======
 delta | Good   | 13:28:53   | 13m 6s | 3685/7384 | none      |
\end{lstlisting}

\subsubsection{Запуск/Остановка репликации}

Запуск репликации:

\begin{lstlisting}[language=Bash,label=lst:bucardo11,caption=Запуск репликации]
$ bucardo start
\end{lstlisting}

Остановка репликации:

\begin{lstlisting}[language=Bash,label=lst:bucardo12,caption=Остановка репликации]
$ bucardo stop
\end{lstlisting}

\subsection{Общие задачи}

\subsubsection{Просмотр значений конфигурации}

\begin{lstlisting}[language=Bash,label=lst:bucardo13,caption=Просмотр значений конфигурации]
$ bucardo show all
\end{lstlisting}

\subsubsection{Изменения значений конфигурации}

\begin{lstlisting}[language=Bash,label=lst:bucardo14,caption=Изменения значений конфигурациии]
$ bucardo set name=value
\end{lstlisting}

Например:

\begin{lstlisting}[language=Bash,label=lst:bucardo15,caption=Изменения значений конфигурации]
$ bucardo_ctl set syslog_facility=LOG_LOCAL3
\end{lstlisting}

\subsubsection{Перегрузка конфигурации}

\begin{lstlisting}[language=Bash,label=lst:bucardo16,caption=Перегрузка конфигурации]
$ bucardo reload_config
\end{lstlisting}

Более подробную информацию можно найти на \href{http://bucardo.org/}{официальном сайте}.